<!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <title>app_mailing</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
        <script type="text/javascript" src="http://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.js"></script>
        <link rel="stylesheet" type="text/css" href="http://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.css" />
    </head>
    <body>
        <div id="tab-example">
            <div id="tabs" style="width: 100%; height: 29px;"></div>
                <div id="tab1" class="tab">
                    <div id="layout" style="width: 100%; height: 600px;"></div>
                </div>
                <div id="tab2" class="tab">
                        <div id="layout2" style="width: 100%; height: 600px;"></div>
                </div>
        </div>
    
<?php $idPage = "mailing"; ?>

<script type="text/javascript">

var jsNomen = <?php echo $this->jsNomen; ?>;

// Création des tabs
var config = {
    tabs: {
        name: 'tabs',
        active: 'tab1',
        tabs: [
            { id: 'tab1', caption: 'Prospects' },
            { id: 'tab2', caption: 'Paramètres' },
        ],
        onClick: function (event) {
            $('#tab-example .tab').hide();
            $('#tab-example #' + event.target).show();
        }
    }
}

$(function () {
    $('#tabs').w2tabs(config.tabs);
    $('#tab1').show();


// Création du layout 1er onglet (Prospects)
    var pstyle = 'background-color: #F0F0C1; border: 1px solid #dfdfdf; padding: 5px;';
    $('#layout').w2layout({
        name: 'layout',
        panels: [
            { type: 'left', size: '60%', resizable: true, hidden: false, style: pstyle, content: ''},
            { type: 'main', resizable: true, hidden : false, style: pstyle, content: ''},
            { type: 'right', size: 600, resizable: true, hidden: true, style: pstyle}
            ]
    })
    
    w2ui['layout'].content('left', 
    $('#grid').w2grid({ 
        name   : 'grid',
        header : 'Grille Prospects',
        show: { 
            header : true,
            toolbar: true,
            footer: true,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: true
            },
        searches: [                
            { field: 'nom_prenom', caption: 'Nom_Prénom', type: 'text' },
            { field: 'etab', caption: 'Etablissement', type: 'text' },
            { field: 'email', caption: 'Email', type: 'text' }
            ],
        columns: [                
            { field: 'nom_prenom', caption: 'Nom_Prénom', size: '40%' },
            { field: 'email_prospect', caption: 'Email', size: '40%' },
            { field: 'email2_prospect', caption: 'Email2', size: '120px' },
            { field: 'etab_prospect', caption: 'Etablissement', size: '30%' },
            { field: 'langue_prospect', caption: 'Langue', size: '30%' },
            { field: 'clientIste_prospect', caption: 'Client Iste', size: '30%' },
            { field: 'membreEdito_prospect', caption: 'Membre editorial', size: '30%' },
        ],
        toolbar: {
		        items: [
		            { id: 'export', type: 'button', caption: 'Exporter', icon: 'fa-file' }
		        ],
        records:[ { recid: 1, fname: 'John', lname: 'Doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' } ] //jsProsp
        
        }
    }))
    
    w2ui['layout'].content('main', 
    $('#grid2').w2grid({ 
        name   : 'grid2',
        header : 'Historique des envois',
        show  : {
            header : true,
            toolbar: true,
        },
        searches: [                
            { field: 'date_envoi', caption: 'Date dernier mail', type: 'date' },
            ],
        columns: [                
            { field: 'date_envoi', caption: 'Date dernier mail', size: '40%' },
            { field: 'nombre_mail', caption: 'Nombre de mails envoyé', size: '20%' },
            { field: 'date_creation', caption: 'Date de création prospect', size: '40%' },
        ],
        records: [
            { recid: 1, fname: 'John', lname: 'Doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' }
        ]
    }))

// Création du layout 2e onglet (Paramètres)
    var pstyle = 'background-color: #F0F0C1; border: 1px solid #dfdfdf; padding: 5px;';
    $('#layout2').w2layout({
        name: 'layout2',
        panels: [
            { type: 'left', size: '70%', resizable: true, hidden: false, style: pstyle, content: ''},
            { type: 'main', resizable: true, hidden: false, style: pstyle, content: ''},
            { type: 'right', size: 600, resizable: true, hidden: true, style: pstyle}
            ]
    })
    
    w2ui['layout2'].content('left', 
    $('#grid3').w2grid({ 
        name   : 'grid3',
        header : 'Etablissement',
        show: { 
            header : true,
            toolbar: true,
            footer: true,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: true,
            },
        searches: [                
            { field: 'affiliation1_etab', caption: 'Affiliation 1', type: 'text' },
            { field: 'affiliation2_etab', caption: 'Affiliation 2', type: 'text' },
            { field: 'responsableLabo_etab', caption: 'Responsable Labo', type: 'text' }
            ],
        columns: [                
            { field: 'url_labo_etab', caption: 'URL du Labo', size: '40%' },
            { field: 'adresse_etab', caption: 'Adresse', size: '40%' },
            { field: 'ville_etab', caption: 'Ville', size: '120px' },
            { field: 'cp_etab', caption: 'Code Postal', size: '30%' },
            { field: 'pays_etab', caption: 'Pays', size: '30%' },
            { field: 'responsableLabo_etab', caption: 'Responsable du Labo', size: '30%' },
            { field: 'affiliation1_etab', caption: 'Affiliation 1', size: '30%' },
            { field: 'affiliation2_etab', caption: 'Affiliation 2', size: '30%' },
            { field: 'origine_etab', caption: 'Origine Etablissement', size: '30%' },
        ],
        records:[ { recid: 1, fname: 'John', lname: 'Doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' } ] //jsEtab
        }))
    

    w2ui['layout2'].content('main', 
    $('#grid4').w2grid({ 
        name   : 'grid4',
        header : 'Nomenclature',
        show  : {
            header : true,
            toolbar: true,
            footer: true,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: true
        },
        searches: [                
            { field: 'label_parent', caption: 'Catégorie Parent', type: 'text' },
            { field: 'label', caption: 'label', type: 'text' }
            ],
        columns: [                
            { field: 'code', caption: 'Code', size: '20%' },
            { field: 'label', caption: 'Label', size: '40%' },
        ],
        records: jsNomen,
        onSave: function(event) {
		            var changes = w2ui['grid_<?php echo $idPage;?>'].getChanges();
		            changes.forEach(function(c, i){
			            c.obj = 'nomenclature';		            
						$.get('<?php if(!$this->ajax) echo '../'; ?>update.phtml',
								c,
								function(js){
									finsession(js);		
									js.rs.text = js.rs.nom+" "+js.rs.prenom;
									setListe(js.rs,'nomenclature');			            				            						        			
									if(changes.length==i+1)w2alert(js.message);
								},"json");                        
		            });
		        },
        onAdd: function(event) {            
		            w2ui['layout2'].hide('left', true);
		            w2ui['layout2'].hide('main', true);
		            w2ui['layout2'].toggle('right', true);
			    },
        onDelete: function(event) {            
                        var p = {id:itemSelect.recid, obj:'nomenclature'};
                        if(event.force){
                            $.get('<?php if(!$this->ajax) echo '../'; ?>delete.phtml',
                            p,
                            function(js){
                                finsession(js);
                                w2alert(js.message);
                            },"json");
                        }
		},
        onSearch: function(event) {
		        		var grid = this;
		        		if(event.search){
		            		event.onComplete = function () {
			            		$.get('<?php if(!$this->ajax) echo '../'; ?>cherche/nomenclature',
							{"searchData":event.searchData},
			            		function(js){
			            			finsession(js);
			            			var ids = [];
			            			js.rs.forEach(function(d){
			            				rsNomen.forEach(function(l, i){
				            				if(l.id_nomenclature==d)ids.push(i);
			            				});
				            		});
		                        grid.last.searchIds = ids;
		                        grid.total      = grid.last.searchIds.length; 
		                        grid.buffered   = grid.total; 
		                        grid.refresh();
		                        w2alert(js.message);
			           		},"json");
		                }
                        }else
                        {
                            grid.localSearch();		            
                            event.onComplete = function () {
                            grid.last.searchIds = grid.last.searchIds;
                            grid.total      = grid.last.searchIds.length; 
                            grid.buffered   = grid.total; 
                            grid.refresh();
                        }			            	
		            }
		        },
            
    }))
    w2ui['layout2'].content('right', 
    $('#form1').w2form({ 
		        name: 'form_nomenclature',
		        focus  : -1,
		        fields: [
                    { name: 'code', type: 'int', required: true, html: { caption: 'Code', attr: 'size="40" maxlength="40"' } },
		            { name: 'label', type: 'text', required: true, html: { caption: 'Label', attr: 'size="40"' } },
		        ],
		    actions: {
		            Save: function () {
		                var errors = this.validate();
		                if (errors.length > 0) return;
		                var data = this.record;
		                data.obj = "nomenclature";
			            $.get('<?php if(!$this->ajax) echo '../'; ?>application/views/scripts/mailing/update.phtml',
						data,
			            function(js){
			            	finsession(js);
			            	w2alert(js.message);
			           	},"json");
		            }
		        }
		    }))	    
        });


</script>
    
</body>
</html>